<mat-toolbar class="page-section-header ">
  <h2>{{logedInUser}} Tasks </h2>
</mat-toolbar>
<mat-card>
  <div class="container">
    <form [formGroup]='formGroup'>
      <div class="row">


        <div class=" col-lg-2">
          <mat-form-field>
            <mat-select placeholder="Select Portal" (change)='onPortalChange()' formControlName="portalId">
              <mat-option *ngFor="let portals of portalList" [value]="portals.id">
                {{portals.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="col-lg-2">
          <mat-form-field>
            <mat-select placeholder="Select Project" formControlName="projectId">
              <mat-option *ngFor="let projects of projectList" [value]="projects.id">
                {{projects.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class=" col-lg-2">
          <mat-form-field>
            <mat-select placeholder="Select Product" formControlName="productId">
              <mat-option *ngFor="let product of productList" [value]="product.id">
                {{ product.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="offset-1 col-lg-1">
          <mat-checkbox formControlName="allTasks" (ngModelChange)="grid($event)">All</mat-checkbox>
        </div>



        <div class="col-lg-4">
          <div class="button-row">
            <button class="pull-right" mat-raised-button color="primary" routerLink="/tasks/add">Create Task </button>
            <button (click)='search()' mat-raised-button class="pull-right" color="primary">Search </button>
            <button (click)='clear()' mat-raised-button class="pull-right">Clear</button>
          </div>
        </div>
      </div>
    </form>

    <div class="row">
      <div class="col-md-12">
        <!--.....................................       Table         ......................................-->
        <p-table [columns]="tableColumns" [(selection)]="selectedCar1" [value]="taskList" [customSort]="true"
          [loading]="loading" [paginator]="false" [responsive]="true" sortField="Id" [lazy]="true"
          (onLazyLoad)="sort($event)" [rowHover]="true" selectionMode="single"  (onRowSelect)='onClickOnSpecificTask($event)'>
          <ng-template pTemplate="header" let-rowData let-columns class="ui-dialog-titlebar">
            <tr>
              <th width="{{col.width}}" *ngFor="let col of columns" [pSortableColumn]="col.field">
                {{col.header}}
                <p-sortIcon [field]="col.field"></p-sortIcon>
              </th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-rowData let-task>
            <tr [pSelectableRow]="rowData">
     
              <td style="border: none">
                <span> <img [src]="decideFlag(task.portalName)" height="20px" width:15px> </span>
                <span style="font-size: 18px; color: black">{{task.name}}</span>
                <span class="pull-right">
                  <span matTooltip="High Priority" *ngIf="task.priorityName === 'High'" class="pull-right"
                    style="color:red; padding-right: 15px;"><b>H</b></span>
                  <span matTooltip="Medium Priority" *ngIf="task.priorityName === 'Medium'" class="pull-right"
                    style="color:#5de95d; padding-right: 14px;"><b>M</b></span>
                  <span matTooltip="Low Priority" *ngIf="task.priorityName === 'Low'" class="pull-right"
                    style="color:#256dd8; padding-right: 17px;"><b>L</b></span>
                </span><br> &nbsp; &nbsp; &nbsp;

                <span style="font-size: 12px"><span style="color: #5cb85c"
                    matTooltip="Product">{{task.productName}}</span> &nbsp; <strong>|</strong>
                  &nbsp;<span style="color:#42a7d0f7" matTooltip="Project">{{task.projectName}}</span>&nbsp;
                  <strong>|</strong> &nbsp;<span style="color:#e01c70" matTooltip="Accountant">{{task.accountantName}}
                  </span>
                  <strong>|</strong> &nbsp; <span class="step" matTooltip="Progress">{{task.progress}} </span>
                </span>
              </td>
              <td style="border: none">
                <span [ngClass]="decideStatus(task.statusName)">{{task.statusName}}</span>
              </td>
              <td style="border: none">{{task.startDate|date : "d/MM/y"}}

              </td>
            </tr>
          </ng-template>


        </p-table>


        <!--  ........................      Paginator      ......................................-->
        <div class="col-md-12">
          <br>
          <p-paginator (onPageChange)="paginate($event)" [rows]="pageSize" [totalRecords]="totalRecords"
            [rowsPerPageOptions]="rowsPerPageOptions" [first]="currentPage" [alwaysShow]="true" pageLinkSize='4'>
          </p-paginator>
        </div>
      </div>
    </div>
  </div>
</mat-card>


<div *ngIf='showDetailComponent'>
  <app-taskdetail (eventToCallParentComponentMethod)="load()" [id]='taskIdOfParentComponent'></app-taskdetail>
</div> 



<!--...............................................         Task Detail        Dialogue                      .................................-->

<!-- <p-dialog [draggable]=false [modal]="true" [positionTop]='50' [(visible)]="showPopUp" [width]="800"
  [contentStyle]="{'max-height':'700px' }">
  <p-header><strong style="color: #c82c00">{{name}}</strong> &nbsp; &nbsp;
    <mat-icon (click)="edit()" class="text_red mat-icon material-icons" role="img" style="font-size:18px;cursor:pointer"
      aria-hidden="true">edit</mat-icon>
    <mat-icon (click)="delete()" class="text_red mat-icon material-icons" role="img"
      style="font-size:10px;cursor:pointer" aria-hidden="true"><i style=" font-size: 19px;" class="material-icons">
        delete
      </i></mat-icon>
  </p-header> -->



  <!-- ..........................       First Row           .............................-->

  <!-- <div class="container-fluid">
    <div class="row">
      <div class="col-md-8">
        <div class="col-md-12">
          <span><strong> Project : </strong> {{projectName}}</span>
        </div><br>
        <div class="col-md-12">
          <span> <strong> Product : </strong> {{productName}}</span>
        </div><br>
        <div class="col-md-12">
          <span> <strong>Assignee : </strong> {{assignedtoName}}</span>
        </div><br>
        <div class="col-md-12">
          <span> <strong>Created : </strong>{{ startDate|date : "d/MMMM/y"}}</span>
        </div><br>
        <div class="col-md-12">
          <span> <strong>Depends On : </strong>
            <span (click)='onRowSelect2()' [ngClass]="taskLinkCss"> {{parentName}}</span>
          </span>
        </div><br>
      </div> -->



      <!-- ..........................       Second Row           .............................-->

      <!-- <div class="col-md-4">
        <div class="col-md-12">
          <mat-menu #statusMenu="matMenu">
            <button (click)="onStatusChange(ct.id,ct.name)" mat-menu-item *ngFor="let ct of statusListDD"
              [value]="ct.id">
              {{ ct.name}}
            </button>
          </mat-menu>
          <span> <strong>Status : </strong>
            <span style="cursor: pointer;" [ngClass]="decideStatus(statusName)" [matMenuTriggerFor]="statusMenu">
              {{statusName}} &nbsp; <i class="fa fa-caret-down"></i></span>
          </span>
        </div> <br>

        <div class="col-md-12">
          <span> <strong> Priority : </strong>&nbsp;
            <span>
              <span matTooltip="High Priority" *ngIf="priorityName === 'High'"
                style="color:red; padding-right: 15px;"><b>H</b></span>
              <span matTooltip="Medium Priority" *ngIf="priorityName === 'Medium'"
                style="color:#5de95d; padding-right: 14px;"><b>M</b></span>
              <span matTooltip="Low Priority" *ngIf="priorityName === 'Low'"
                style="color:#256dd8; padding-right: 17px;"><b>L</b></span>
            </span>
          </span>
        </div> <br>
        <div class="col-md-12">
          <span> <strong>Country : </strong>
            <span> <img [src]="decideFlag(portalName)" height="20px" width:15px> </span>
          </span>
        </div> <br>
        <div class="col-md-12">
          <span> <strong>Target : </strong>{{targetDate|date : "d/MMMM/y"}}</span>
        </div> <br>
      </div>
    </div>
    <br> -->


    <!-- ..........................       Tasks Dependencies         .............................-->
    <!-- <div class="col-12" *ngIf='DonotShowOneTask'>
      <strong class="text_red">Tasks Dependencies:
        <hr></strong>

      <div class="row ">
        <div (click)='goToTask(list)' style="display: inline; cursor: pointer;   " class="col-md-3 onhover"
          *ngFor='let list of dependencyTableList; let i=index'>
          <span>
            <span style="padding-right: 19px">{{list.name}} <br>
              <span style="font-size: 10px"> {{list.assignedtoName}}</span> &nbsp; <span style="font-size: 8px"
                [ngClass]="decideStatus(list.statusName)">{{list.statusName}}</span>
            </span>
          </span> <br><br>
        </div>
      </div>
    </div><br>
    <div class="col-12">
      <strong class="text_red"> Task Items: <a (click)='showSaveItemsPopUp()'><i
            style="background-color: white; color: green; cursor: pointer;"
            class="material-icons pull-right">add_box</i></a>
        <hr></strong> -->




      <!--      Task ITems Table ---------------------------------            -->
      <!-- <p-table [columns]="taskItemCols" [value]="taskItemList" [customSort]="false" [loading]="loading"
        [responsive]="true" [resizableColumns]="true" [rowHover]="false" [paginator]="false" [lazy]="true">

        <ng-template pTemplate="header" let-rowData let-columns class="ui-dialog-titlebar">
          <tr>
            <th [ngClass]="col.css" width="{{col.width}}" *ngFor="let col of columns" [pSortableColumn]="col.field"
              pResizableColumn>
              {{col.header}}
            </th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-rowData let-task>
          <tr [pSelectableRow]="rowData">
            <td style="border: none">
              <span>{{task.name}}</span>
            </td>
            <td style="border: none">
              &nbsp; &nbsp; &nbsp;
              <mat-checkbox (change)='updateTaskitemStatus(task)' [checked]=task.isCompleted></mat-checkbox>
              &nbsp; &nbsp; &nbsp; &nbsp;
              <button mat-icon-button [matMenuTriggerFor]="menu">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #menu="matMenu">
                <button mat-menu-item (click)="editTaskItem(rowData)">
                  <span class="actionmenu_list">
                    <mat-icon>mode_edit</mat-icon>
                    <span>Edit</span>
                  </span>
                </button>

                <button mat-menu-item (click)="deleteItem(rowData)">
                  <span class="actionmenu_list">
                    <mat-icon>delete</mat-icon>
                    <span>Delete</span>
                  </span>
                </button>
              </mat-menu>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div> <br><br>




    <div class="col-11">
      <strong class="text_red">Description:
        <hr></strong>
      <span [innerHTML]="description"> </span>
    </div> <br><br>


    <div class="col-11">
      <strong class="text_red">Attachments:</strong>
      <hr>


      <div class="attachments">
        <div class="row">
          <div class="col-md-6" *ngFor="let attachment of attachmentList">
            <div class="row issue_attachments">
              <div class="col-md-4">
                <img src="{{getAttachmentPath(attachment)}}"
                  style=" border: 1px solid lightgray;  width: 80px;height: 80px;" alt="">
              </div>
              <div class="col-md-8">
                <div class="row">
                  <p style="font-size: 12px">
                    <a href="{{getAttachmentPath(attachment)}}" download>{{attachment.fileName}}</a>
                    <span> {{attachment.dT_Created | date:"d/MM/y hh:mm"}}</span>
                  </p>
                </div>
              </div>
            </div>
            <br>
          </div>
        </div>
      </div>
 -->



      <!--..................................................      Comments      ..........................................................-->
      <!-- <h4 class="page_title_1">Comments

      </h4>
      <div class="row">
        <div class="col-lg-12">
          <div class="col-md-12 ">
            <p-editor [(ngModel)]="parentComment" placeholder="Write Description Here" [style]="{'height':'150px'}">
            </p-editor>
          </div>

          <div class="col-lg-10 offset-2">
            <div class="button-row">
              <button style="background-color: red" mat-raised-button color="primary" class="pull-right"
                (click)="saveComment(0)">Comment</button>
            </div>
          </div>
          <br><br><br><br>
          <div class="col-lg-12">
            <div *ngFor="let i of CommentList">
              <div class="comment_parent">


                <div class="row">
                  <div class="col-7">
                    <span class="comment_header" [innerHTML]="i.preview"> </span>
                  </div>
                  <div class="col-1">

                  </div>
                  <div class="col-4">
                    <span style="padding-top: 5px" class="pull-right">
                      <span style="font-size: 11px">{{i.userName}}</span><br>
                      <span style="font-size: 11px">{{i.dT_Created | date:"d/MM/y hh:mm"}}</span> &nbsp;
                      <mat-icon (click)="deleteComment(i.id)" class="text_red mat-icon material-icons pull-right"
                        role="img" style="font-size:13px;cursor:pointer" aria-hidden="true"><i style=" font-size: 13px;"
                          class="material-icons">
                          delete
                        </i></mat-icon>
                    </span>
                  </div>
                </div>
                <div class="row">

                  <div class="col-md-8">
                    <mat-form-field class="removetopmargin">
                      <input matInput [value]="childComment" placeholder="Reply here .."
                        (blur)="childComment = $event.target.value">
                    </mat-form-field>
                  </div>

                  <div class="col-md-4">
                    <br>
                    <button style="background-color: #5cb85a; min-width: 50px; line-height: 24px;" mat-mini-fab
                      color="primary" (click)="saveComment(i.id)" class="pull-right ">Reply</button>

                  </div>
                </div>




              </div> <br>




              <div class="col-lg-10 offset-2" *ngIf="i.issueComment.length > 0">
                <div *ngFor="let itemChild of i.issueComment;">
                  <div class="row">
                    <div class="col-9">
                      <span style="font-weight: 100; color: #800000" [innerHTML]="itemChild.preview"></span>
                    </div>

                    <div class="col-3" class="pull-right" style="font-size: 12px">
                      <span style="font-size: 11px">{{itemChild.userName}}</span><br>
                      <span style="font-size: 10px">{{itemChild.dT_Created | date:"d/MM/y hh:mm"}}</span> &nbsp;
                      <mat-icon (click)="deleteComment(itemChild.id)"
                        class="text_red mat-icon material-icons pull-right" role="img"
                        style="font-size:13px;cursor:pointer" aria-hidden="true"><i style=" font-size: 13px;"
                          class="material-icons">
                          delete
                        </i></mat-icon>

                    </div>

                  </div>
                </div>
              </div>



              <br> <br>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</p-dialog> -->

<!--...............................................  Completed  Time  Dialogue                   .................................-->

<!-- <p-dialog [draggable]=false [modal]="true" [positionTop]='150' [(visible)]="showHoursPopUp" [width]="300"
  [contentStyle]="{'max-height':'300px' }">
  <p-header><strong style="color: #c82c00"> Time Spent </strong>
  </p-header>
  <div class="container-fluid">
    <div class="row">

      <button style="color:white; background-color: white" mat-button></button>
      <div class="col-lg-12">
        <mat-form-field>
          <input #showError="ngModel" required pattern="(.*)[0-9]{1}[A-Za-z]{1}" matInput placeholder="eg. 3w 4d 2h"
            [(ngModel)]="TimeTaken" ngModel>
        </mat-form-field>

    <div [hidden]="showError.valid" class="alert alert-danger">
          Please Enter like 3w or 4d or 2h
        </div>
      </div>
      <div class=" col-lg-12">
        <button [disabled]="!showError.valid" (click)='UpdateCompletedTaskTime()' style="background-color: red"
          mat-raised-button color="primary" class="pull-right">Save</button>
      </div>
  </div>
  </div>
</p-dialog> -->


<!--...............................................   Task Items Dialogue                   .................................-->

<!-- <p-dialog [draggable]=false [modal]="true" [positionTop]='150' [(visible)]="showTaskItemPopUp" [width]="400"
  [contentStyle]="{'max-height':'300px' }">

  <p-header><strong style="color: #c82c00"> Task Items </strong>

  </p-header>



  <div class="container-fluid">
    <div class="row">

      <button style="color:white; background-color: white" mat-button></button>
      <div class="col-md-12">
        <mat-form-field>
          <input [(ngModel)]='taskItemName' matInput placeholder="Task Item">
        </mat-form-field>
      </div>

    </div>
  </div>
  <div class="button-row">
    <button (click)='saveTaskItems()' style="background-color: red" mat-raised-button color="primary"
      class="pull-right">Save</button>
  </div>
</p-dialog> -->


